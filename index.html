<!DOCTYPE html>
<html>

<script type="text/javascript" src="jszip.js"></script>
<title>Offline Comic Reader</title>
<body>

    <div id="drop_zone">Drop images or zip or cbz here
        <div>
            <input type="file" id="file-uploader" class="inputfile" />
            <label for="file-uploader">Or choose a file</label>
        </div>
    </div>

    <div id="setting-bar" class="setting-bar">
        <div class="table">
            <ul>
                <!-- <li><a href="#home" onclick="selectSetting(this)" class="active">Home</a></li> -->
                <li><a onclick="selectSetting(this)">DarkMode</a></li>
                <li><a onclick="selectSetting(this)">SeparatorLine</a></li>
                <li><a onclick="selectSetting(this)">About</a></li>
            </ul>
        </div>
    </div>

    <output id="list" class="images-list"></output>

</body>

<style>
    :root {
        --separator-line-color: rgba(98, 77, 77, 0.212);
        --page-background-color: rgb(255, 255, 255);

        /* SeparatorLine  */
        --separator-line-border-bottom-size: 1px;
        --separator-line-padding: 30px;

        --setting-bar-background-color: #f3f3f3;
    }

    [data-theme="dark"] {
        --separator-line-color: rgba(223, 213, 213, 0.212);
        --page-background-color: rgb(53, 57, 59);
        --setting-bar-background-color: #514d4d;
    }

    [separator-line-mode="off"] {
        --separator-line-border-bottom-size: 0px;
        --separator-line-padding: 0px;
    }

    html {
        background-color: var(--page-background-color);
    }

    /* setting-bar */
    .setting-bar {
        margin-bottom: 5px;
        margin-top: 5px;
        border: 1px solid #e7e7e7;
        background-color: var(--setting-bar-background-color);
    }

    .setting-bar .table {
        display: table;
        /* Allow the centering to work */
        margin: 0 auto;
    }

    .setting-bar ul {
        list-style-type: none;
        margin: 0;
        padding: 0;
        overflow: hidden;
    }

    .setting-bar li {
        float: left;
    }

    .setting-bar li a {
        display: block;
        color: #666;
        text-align: center;
        padding: 14px 16px;
        text-decoration: none;
    }

    .setting-bar li a:hover:not(.active) {
        background-color: #ddd;
    }

    .setting-bar li a.active {
        color: white;
        background-color: rgb(99, 110, 100);
    }

    /* images-list */
    .images-list img {
        display: block;
        margin: 0 auto;
        width: 500px;
    }

    .images-list ul {
        list-style: none;
        margin-inline-end: 40px;
        padding-inline-start: 40px;
    }

    .images-list li {
        /* SeparatorLine  */
        border-bottom: var(--separator-line-border-bottom-size) solid var(--separator-line-color);
        padding: var(--separator-line-padding);
    }

    /* drop_zone */
    #drop_zone {
        border: 2px dashed #bbb;
        -moz-border-radius: 5px;
        -webkit-border-radius: 5px;
        border-radius: 5px;
        padding: 45px;
        text-align: center;
        font: 20pt bold 'Vollkorn';
        color: #bbb;

        margin-bottom: 5px;
        margin-top: 5px;

        font-size: 18px;
    }

    /* Input file */
    .inputfile {
        width: 0.1px;
        height: 0.1px;
        opacity: 0;
        overflow: hidden;
        position: absolute;
        z-index: -1;
    }

    .inputfile + label {
        font-size: 80%;
        cursor: pointer;
        /* display: inline-block; */
        text-decoration: underline;
        border-radius: 30px;
        padding: 2.5px;
    }

    .inputfile:focus + label,
    .inputfile + label:hover {
        background-color: var(--setting-bar-background-color);
    }

</style>


<script>

    function selectSetting(evt) {
        if (evt.className == "active") {
            evt.removeAttribute("class")

            if (evt.text == "DarkMode") {
                switchTheme()
            }
            else if (evt.text == "SeparatorLine") {
                switchSeparatorLineMode()
            }
        }
        else {
            evt.setAttribute("class", "active")

            if (evt.text == "DarkMode") {
                // alert("DarkMode is not supported yet");
                // evt.removeAttribute("class")
                switchTheme()
            }
            else if (evt.text == "SeparatorLine") {
                switchSeparatorLineMode()
            }
            else if (evt.text == "About") {

            }
        }

    }

    /// ---- ///

    // Init
    document.documentElement.setAttribute('data-theme', 'light');
    document.documentElement.setAttribute('separator-line-mode', 'off');

    function switchTheme() {
        // See: https://dev.to/ananyaneogi/create-a-dark-light-mode-switch-with-css-variables-34l8

        if (document.documentElement.getAttribute("data-theme") == 'light') {
            document.documentElement.setAttribute('data-theme', 'dark');
        }
        else {
            document.documentElement.setAttribute('data-theme', 'light');
        }
    }

    function switchSeparatorLineMode() {
        if (document.documentElement.getAttribute("separator-line-mode") == 'activate') {
            document.documentElement.setAttribute('separator-line-mode', 'off');
        }
        else {
            document.documentElement.setAttribute('separator-line-mode', 'activate');
        }
    }

    // const toggleSwitch = document.querySelector('.theme-switch input[type="checkbox"]');
    // toggleSwitch.addEventListener('change', switchTheme, false);

    /// ---- ///

    function handleButtonUploadFile(e) {
        var files = e.target.files;
        // if (!files[0]) {
        //     return;
        // }
        loadFiles(files);
    }

    function handleFileDragSelect(evt) {
        evt.stopPropagation();
        evt.preventDefault();

        var files = evt.dataTransfer.files; // FileList object.
        loadFiles(files);
    }

    function loadFiles(files) {
        if (files[0].name.toLowerCase().endsWith(".zip") ||
            files[0].name.toLowerCase().endsWith(".cbz")) {
                updateZipImages(files);
        }
        else {
            files = [].slice.call(files)
            updateDirectImages(files);
        }
    }

    function updateDirectImages(files) {
        files = files.map(o=> {return {data: o, name: o.name};});
        updateImages(files);
    }

    function updateZipImages(files) {
        var zip = new JSZip();

        zip.loadAsync( files[0] /* = file blob */)
        .then(function(zipContent) {
            var zipEntriesList = [];
            var promisesArr = [];
            zipContent.forEach(function (relativePath, zipEntry) {             
                asyncBlob = zipContent.files[relativePath].async('blob');
                promisesArr.push(asyncBlob);
                asyncBlob.then(function(data) {
                    zipEntriesList.push({data, name: relativePath});
                })
            });

            Promise.all(promisesArr).then(function(values) {
                updateImages(zipEntriesList)
            });

        }, function() {
            alert("Not a valid .zip or .cbz file")
        }); 
    }

    function updateImages(files) {
        files.sort((a, b) => (a.name > b.name) ? 1 : ((b.name > a.name) ? -1 : 0));

        const fileList = document.getElementById("list");
        fileList.innerHTML = "";
        const list = document.createElement("ul");
        fileList.appendChild(list);

        for (var i = 0, f; f = files[i]; i++) {
            const li = document.createElement("li");
            list.appendChild(li);

            const img = document.createElement("img");
            img.src = window.URL.createObjectURL(f.data);
            img.onload = function () {
                window.URL.revokeObjectURL(this.src);
            }
            li.appendChild(img);
        }
    }

    function handleDragOver(evt) {
        evt.stopPropagation();
        evt.preventDefault();
        evt.dataTransfer.dropEffect = 'copy'; // Explicitly show this is a copy.
    }

    // Setup the dnd listeners.
    var dropZone = document.getElementById('drop_zone');
    dropZone.addEventListener('dragover', handleDragOver, false);
    dropZone.addEventListener('drop', handleFileDragSelect, false);

    document.getElementById('file-uploader')
    .addEventListener('change', handleButtonUploadFile, false);
</script>

</html>
